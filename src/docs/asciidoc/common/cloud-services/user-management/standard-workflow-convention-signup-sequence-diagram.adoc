:relative-path: ../../../
include::{docdir}/variables.adoc[]


[plantuml, standard-workflow-convention-signup-sequence-diagram, png]
.Signup
....
autonumber


box "front" #LightBlue
actor User
participant "Front"
participant "StandardUserWorkflow[front]" 
end box

note left of Front
  form fields:
  - username
  - email
  - password
  - confirmPassword
end note
User -[#0000FF]> Front: signup(form)

Front -[#0000FF]> Front: accountCreationDetails
note right of Front
  accountCreationDetails = {
    username,
    email,
    password,
    confirmPassword
  }
end note

Front -[#0000FF]> Front: confirmationRedirection
note right of Front
  confirmationRedirection = {
    url: "${zp.front.url}/#account-confirmation/${confirmation.token}"
  }
end note

Front -[#0000FF]> "StandardUserWorkflow[front]": signup(accountDetails, confirmationRedirection)
"StandardUserWorkflow[front]" -[#999999]-> "StandardUserWorkflow[cloud]": remote call
activate "StandardUserWorkflow[cloud]"

"StandardUserWorkflow[cloud]" -> UsernamePasswordAccountCreationManager: signup(accountDetails)
activate UsernamePasswordAccountCreationManager
database UserCloudServiceStorage
UsernamePasswordAccountCreationManager -> UserCloudServiceStorage: store()
"StandardUserWorkflow[cloud]" <-- UsernamePasswordAccountCreationManager: account: Account
deactivate UsernamePasswordAccountCreationManager

"StandardUserWorkflow[cloud]" -> TemplatedMessageAccountConfirmationManager: askConfirmation(account)
activate TemplatedMessageAccountConfirmationManager


TemplatedMessageAccountConfirmationManager -> ExpirableTokenGenerator: generate()
activate ExpirableTokenGenerator
TemplatedMessageAccountConfirmationManager <-- ExpirableTokenGenerator: {token, expires}
deactivate ExpirableTokenGenerator

TemplatedMessageAccountConfirmationManager -> UserCloudServiceStorage: savePendingConfirmation(account, token, expires)

TemplatedMessageAccountConfirmationManager -> StringTemplateManager: location = new DefaultResourceLocation('templates/email/confirm.html')\nvariables = new Variables({zp, account, confirmation: {token, expires}})\nloadAndParse(location, variables)
activate StringTemplateManager
note right of TemplatedMessageAccountConfirmationManager
  `zp = zetaPushContextProvider.current()`
  It means that zp contains information about 
  current application, environment, deployment URL...
end note

StringTemplateManager -> StringResourceResolver: resolve(location)
activate StringResourceResolver
StringTemplateManager <-- StringResourceResolver: template: StringResource
deactivate StringResourceResolver

StringTemplateManager -> ExtractSubjectTemplateParserDecorator: parse(template, variables)
activate ExtractSubjectTemplateParserDecorator


ExtractSubjectTemplateParserDecorator -> StringTemplateParser: parse(template, variables)
activate StringTemplateParser
ExtractSubjectTemplateParserDecorator <-- StringTemplateParser: evaluatedTemplate: ParsedStringTemplate
deactivate StringTemplateParser
ExtractSubjectTemplateParserDecorator -> ExtractSubjectTemplateParserDecorator: extractSubject()
activate ExtractSubjectTemplateParserDecorator
deactivate ExtractSubjectTemplateParserDecorator
StringTemplateManager <-- ExtractSubjectTemplateParserDecorator: emailTemplate: SubjectAndBodyTemplate
TemplatedMessageAccountConfirmationManager <-- StringTemplateManager: emailTemplate
deactivate StringTemplateManager

TemplatedMessageAccountConfirmationManager -> EmailCloudServiceSender: send({to: account.email, body: emailTemplate.body, subject: emailTemplate.subject})
activate EmailCloudServiceSender

TemplatedMessageAccountConfirmationManager -> TemplatedMessageAccountConfirmationManager: pendingAccount = new PendingAccountConfirmation(account)
"StandardUserWorkflow[cloud]" <-- TemplatedMessageAccountConfirmationManager: pendingAccount
deactivate EmailCloudServiceSender
deactivate TemplatedMessageAccountConfirmationManager
"StandardUserWorkflow[front]" <-[#999999]-- "StandardUserWorkflow[cloud]": pendingAccount
deactivate "StandardUserWorkflow[cloud]"
Front <-[#0000FF]-- "StandardUserWorkflow[front]": pendingAccount

...User clicks on the link provided in the email...

Front -[#0000FF]> Front: extract token from window.location
Front -[#0000FF]> "StandardUserWorkflow[front]": confirm({token})
"StandardUserWorkflow[front]" -[#999999]-> "StandardUserWorkflow[cloud]": remote call
activate "StandardUserWorkflow[cloud]"

"StandardUserWorkflow[cloud]" -> TemplatedMessageAccountConfirmationManager: confirm({token})
activate TemplatedMessageAccountConfirmationManager

TemplatedMessageAccountConfirmationManager -> UserCloudServiceStorage: getConfirmationByToken({token})
TemplatedMessageAccountConfirmationManager <-- UserCloudServiceStorage: {account, token, expires}
TemplatedMessageAccountConfirmationManager -> TemplatedMessageAccountConfirmationManager: validate(token, expires)
activate TemplatedMessageAccountConfirmationManager
deactivate TemplatedMessageAccountConfirmationManager
TemplatedMessageAccountConfirmationManager -> UserCloudServiceStorage: confirmAccount(account)
TemplatedMessageAccountConfirmationManager <-- UserCloudServiceStorage: confirmedAccount

"StandardUserWorkflow[cloud]" <-- TemplatedMessageAccountConfirmationManager: confirmedAccount
deactivate TemplatedMessageAccountConfirmationManager
"StandardUserWorkflow[front]" <-[#999999]-- "StandardUserWorkflow[cloud]": confirmedAccount
deactivate "StandardUserWorkflow[cloud]"
Front <-[#0000FF]-- "StandardUserWorkflow[front]": confirmedAccount

note left of Front
  User is now registered and 
  can login into your application
end note
....